import{j as e}from"./vendor-ui-CtvHukzg.js";import{R as r,r as t,u as a,w as s,a as i}from"./vendor-data-BY55b65u.js";import{u as n}from"./useTimedMessage-3v5eabB6.js";import{f as l}from"./date-BJLw6yVC.js";import{u as o,a as c,D as d}from"./main-BtLJocfP.js";import{D as u}from"./DattaPageTitle-T82UHXFU.js";import{D as p,T as m}from"./DattaTabs-D7AxHKPN.js";import{D as h}from"./DattaCard-Ca8oAgyz.js";import{a as x,D as g}from"./DattaForm-CDg-NNVW.js";import{D as v}from"./DattaModal-BlJ6BfOc.js";import{D as y}from"./DattaNetworkDataTable-CKoFfAgq.js";import"./vendor-react-DjGYZWH8.js";const f=({children:r})=>e.jsx("span",{children:r}),j=({children:r})=>e.jsx(e.Fragment,{children:r});function b({activeStep:t=0,children:a}){const s=r.Children.map(a,((a,s)=>{if(!a)return null;const i=r.Children.toArray(a.props.children).find((e=>(null==e?void 0:e.type)===f)),n=i?i.props.children:"",l=s<t?"completed":s===t?"active":"",o=a.props.disabled;return e.jsx("li",{className:`step ${l} ${o?"disabled":""}`,children:n})}));return e.jsx("ul",{className:"stepper mb-3",children:s})}const C=[{value:"text",label:"Texte"},{value:"number",label:"Nombre"},{value:"date",label:"Date"},{value:"list",label:"Liste déroulante"},{value:"checkbox",label:"Case à cocher"}];function N({user:r}){const N=t.useRef(),[w,S]=t.useState([]),[_,k]=t.useState([]),[$,q]=t.useState([]),[I,E]=t.useState(""),[L,T]=t.useState(""),[z,D]=t.useState({}),[A,F]=t.useState({}),[R,O]=t.useState({}),{message:M,setTimedMessage:P}=n({text:"",type:"info"}),[H,V]=t.useState("file"),[B,U]=t.useState(1),[J,Q]=t.useState(null),[X,Z]=t.useState(null),[G,W]=t.useState(""),[K,Y]=t.useState(!1),[ee,re]=t.useState(0),[te,ae]=t.useState({host:"",port:1521,serviceName:"",username:"",password:"",query:""}),[se,ie]=t.useState(!1),[ne,le]=t.useState([]),[oe,ce]=t.useState(""),[de,ue]=t.useState(""),[pe,me]=t.useState(!1),[he,xe]=t.useState("manual"),[ge,ve]=t.useState([]),[ye,fe]=t.useState(null),[je,be]=t.useState(!1),[Ce,Ne]=t.useState(""),[we,Se]=t.useState(""),{performSync:_e}=o();t.useCallback((async()=>{Y(!0);try{const r=window.api&&window.api.getCategories?await window.api.getCategories():{success:!0,data:[]};r.success&&S(r.data);try{const e=await window.api.getOracleConfigs();e.success&&le(e.data)}catch(e){}try{const e=JSON.parse(localStorage.getItem("importMappingTemplates")||"[]");Array.isArray(e)&&q(e)}catch(e){q([])}await _e()}catch(r){P({text:r.message,type:"error"})}finally{Y(!1)}}),[_e]),t.useEffect((()=>{const e=(e,r)=>{r&&"number"==typeof r.percent&&re(r.percent)};return window.api&&window.api.onImportProgress&&window.api.onImportProgress(e),()=>{window.api&&window.api.removeImportProgressListener&&window.api.removeImportProgressListener(e)}}),[]);const ke=e=>{const r=e.target.files[0];if(!r)return void P({text:"Aucun fichier sélectionné.",type:"error"});W(r.name),P({text:`Fichier "${r.name}" sélectionné.`,type:"info"});const t=new FileReader;t.onload=e=>{const r=e.target.result;Z(r);try{const e=i(r,{type:"binary",cellDates:!0}),t=e.SheetNames[0],s=e.Sheets[t],n=a.decode_range(s["!ref"]),l=[];if(0===n.s.r)for(let r=n.s.c;r<=n.e.c;++r){const e=s[a.encode_cell({r:0,c:r})];l.push(e?a.format_cell(e):`Colonne ${r+1}`)}const o=a.sheet_to_json(s,{header:1,defval:""}),c=o.length>1?o.slice(1):[];if(0===l.length&&o.length>0&&l.push(...o[0].map(String)),0===l.length)return P({text:"Impossible de lire les en-têtes du fichier. Vérifiez le format.",type:"error"}),void Q(null);Q({headers:l,rows:c.slice(0,5).map((e=>l.map(((r,t)=>e[t]||"")))),rawHeaders:l});const d={},u={},p={};l.forEach((e=>{d[e]="map",p[e]="",u[e]={categorie_id:w.length>0?w[0].id.toString():"",newCategorieNom:"",label:e,key:e.toLowerCase().replace(/[^a-z0-9_]/g,"_").substring(0,50)||`champ_${Date.now()}`,type:"text",obligatoire:!1,visible:!0,readonly:!1,afficherEnTete:!1,options:[],maxLength:null,ordre:0}})),F(d),O(u),D(p),ue(""),U(2)}catch(t){P({text:`Erreur lors de la lecture du fichier: ${t.message}. Assurez-vous que c'est un format CSV ou Excel valide.`,type:"error"}),Q(null),Z(null),W(""),N.current&&(N.current.value="")}},t.onerror=()=>{P({text:"Erreur lors de la lecture du fichier.",type:"error"}),Z(null),W(""),N.current&&(N.current.value="")},t.readAsBinaryString(r)},$e=()=>{de?(F((e=>({...e,[de]:"map"}))),D((e=>({...e,[de]:"numero_unique"}))),O((e=>({...e,[de]:{...e[de]}}))),U(3)):P({text:"La sélection du champ pour le numéro d'individu est obligatoire.",type:"error"})},qe=(e,r)=>{F((t=>({...t,[e]:r}))),"ignore"===r?D((r=>({...r,[e]:"ignorer"}))):"ignorer"===z[e]&&D((r=>({...r,[e]:""}))),"create"===r&&D((r=>({...r,[e]:""})))},Ie=(e,r,t)=>{O((a=>({...a,[e]:{...a[e],[r]:t}})))},Ee=()=>{const e=L.trim();if(!e)return void P({text:"Veuillez donner un nom au template.",type:"error"});const r={name:e,source:H,mapping:z,columnActions:A,nouveauxChamps:R,..."oracle"===H&&{oracleConfig:{host:te.host,port:te.port,serviceName:te.serviceName,username:te.username},query:te.query}},t=$.filter((r=>r.name!==e)).concat(r);q(t),localStorage.setItem("importMappingTemplates",JSON.stringify(t)),T(""),E(e),P({text:`Template "${e}" enregistré.`,type:"success"})},Le=async()=>{try{const e=await window.api.getOracleImportPresets(r.id);e.success&&ve(e.data)}catch(e){}},Te=async()=>{if("file"===H){if(!X)return void P({text:"Veuillez sélectionner un fichier.",type:"error"})}else if(!te.query)return void P({text:"Aucune requête Oracle fournie.",type:"error"});if(!de||"numero_unique"!==z[de])return void P({text:'Le numéro d\'individu doit être identifié et mappé à "numero_unique".',type:"error"});if(!J||!J.rawHeaders||!Array.isArray(J.rawHeaders))return void P({text:"Données d'aperçu invalides. Veuillez recharger le fichier.",type:"error"});if(!A||"object"!=typeof A)return void P({text:"Actions des colonnes non définies. Veuillez reconfigurer le mapping.",type:"error"});if(!z||"object"!=typeof z)return void P({text:"Mapping des colonnes non défini. Veuillez reconfigurer le mapping.",type:"error"});let e=[];const t={},n=new Set,o=new Set,c=new Map;if(0===J.rawHeaders.length)return void P({text:"Aucune colonne trouvée dans le fichier.",type:"error"});if(J.rawHeaders.forEach((r=>{var a,s,i,l,d;const u=A[r];if("map"===u){const a=z[r];r===de?"numero_unique"!==a&&e.push(`La colonne "${r}" (numéro d'individu) doit être mappée à "numero_unique".`):a&&"ignorer"!==a?(o.has(a)&&"numero_unique"!==a&&e.push(`Champ de destination "${a}" est mappé plusieurs fois.`),o.add(a)):e.push(`Colonne "${r}": Veuillez spécifier un champ de destination ou l'ignorer.`),t[r]={action:u,targetField:a}}else if("create"===u){const o=R[r];if(o.categorie_id||e.push(`Colonne "${r}": Sélectionnez une catégorie pour le nouveau champ.`),"__new__"!==o.categorie_id||(null==(a=o.newCategorieNom)?void 0:a.trim())||e.push(`Colonne "${r}": Nom de la nouvelle catégorie manquant.`),(null==(s=o.label)?void 0:s.trim())||e.push(`Colonne "${r}": Libellé manquant pour le nouveau champ.`),(null==(i=o.key)?void 0:i.trim())&&/^[a-zA-Z0-9_]+$/.test(o.key.trim())?(n.has(o.key.trim())&&e.push(`Clé de nouveau champ "${o.key.trim()}" (colonne "${r}") dupliquée dans cet import.`),n.add(o.key.trim())):e.push(`Colonne "${r}": Clé invalide ("${null==(l=o.key)?void 0:l.trim()}"). Utilisez uniquement lettres, chiffres, underscores.`),"list"!==o.type||o.options&&0!==o.options.length||e.push(`Colonne "${r}": Options manquantes pour le type liste.`),"__new__"===o.categorie_id&&(null==(d=o.newCategorieNom)?void 0:d.trim())){const e=o.newCategorieNom.trim(),a=e.toLowerCase(),s=w.find((e=>e.nom.toLowerCase()===a));if(s)t[r]={action:"create_in_existing_category",targetCategoryId:s.id,fieldConfig:{...o,key:o.key.trim(),label:o.label.trim(),categorie_id:s.id,newCategorieNom:void 0,ordre:Number(o.ordre)||0,maxLength:"text"===o.type&&o.maxLength?parseInt(o.maxLength,10):null,afficherEnTete:o.afficherEnTete||!1}};else{c.has(a)||c.set(a,{nom:e,champs:[],colonnes:[]});const s=c.get(a);s.champs.push({...o,key:o.key.trim(),label:o.label.trim(),newCategorieNom:e,ordre:Number(o.ordre)||0,maxLength:"text"===o.type&&o.maxLength?parseInt(o.maxLength,10):null,afficherEnTete:o.afficherEnTete||!1}),s.colonnes.push(r),t[r]={action:"create_in_new_category",newCategoryName:e,fieldConfig:{...o,key:o.key.trim(),label:o.label.trim(),ordre:Number(o.ordre)||0,maxLength:"text"===o.type&&o.maxLength?parseInt(o.maxLength,10):null,afficherEnTete:o.afficherEnTete||!1}}}}else o.categorie_id&&"__new__"!==o.categorie_id&&(t[r]={action:"create",fieldConfig:{...o,key:o.key.trim(),label:o.label.trim(),categorie_id:o.categorie_id,newCategorieNom:void 0,ordre:Number(o.ordre)||0,maxLength:"text"===o.type&&o.maxLength?parseInt(o.maxLength,10):null,afficherEnTete:o.afficherEnTete||!1}})}else"ignore"===u&&(t[r]={action:"ignore"})})),e.length>0)return void P({text:"Erreurs de validation:\n- "+e.join("\n- "),type:"error"},15e3);const d=Array.from(c.values());let u="";if(c.size>0){u+="Nouvelles catégories qui seront créées (si elles n'existent pas déjà sous un nom similaire) :\n";for(const[e,r]of c)u+=`• "${r.nom}" avec ${r.champs.length} champ(s) : ${r.champs.map((e=>`"${e.label}" (clé: ${e.key})`)).join(", ")}\n`}u&&P({text:"Préparation de l'import...\n"+u.substring(0,300)+(u.length>300?"...":""),type:"info"},1e4),Y(!0),re(0),P({text:"Importation en cours...",type:"info"});try{let e=X;if("oracle"===H){const r=await window.api.executeOracleQuery({config:te,query:te.query,maxRows:5e4});if(!r.success)return P({text:r.error||"Erreur exécution requête",type:"error"}),void Y(!1);const t=r.data.metaData.map((e=>e.name)),i=r.data.rows,n=a.aoa_to_sheet([t,...i]),l=a.book_new();a.book_append_sheet(l,n,"Sheet1"),e=s(l,{type:"binary",bookType:"xlsx"}),W("oracle.xlsx")}const n=i(e,{type:"binary",cellDates:!0,cellStyles:!0,cellFormulas:!1}),o=n.SheetNames[0],c=n.Sheets[o],u=a.sheet_to_json(c,{header:1,defval:"",raw:!1}),p=(u.length>1?u.slice(1):[]).map(((e,r)=>{try{return function(e,r,t,a){return e&&Array.isArray(e)&&r&&Array.isArray(r)&&t?e.map(((e,s)=>{const i=r[s];if(void 0===i)return e;const n=t[i];if(!n||"ignore"===n.action)return e;const o=function(e,r,t){var a;if(!r)return null;if("create"===r.action||"create_in_existing_category"===r.action||"create_in_new_category"===r.action)return(null==(a=r.fieldConfig)?void 0:a.type)||null;if("map"===r.action){if("numero_unique"===r.targetField)return"text";const e=t.find((e=>e.key===r.targetField));return(null==e?void 0:e.type)||null}return null}(0,n,a);let c=e;return"number"===o?c=function(e){if("string"==typeof e){const r=e.replace(/'/g,"");if(/^-?\d*\.?\d+$/.test(r)){const e=parseFloat(r);if(!isNaN(e)&&isFinite(e))return e}}else if("number"==typeof e)return e;return e}(e):"date"===o&&(c=l(e)),c})):e}(e,J.rawHeaders,t,_)}catch(a){return e}})),m={source:H,fileContent:e,fileName:G,numeroIndividuHeader:de,columns:t,newCategories:d,userId:r.id||r.userId,createIfMissing:pe,cleanedData:p,headers:J.rawHeaders},h=await window.api.importCSV(m);if(h.success){let e="Importation réussie !";if(h.insertedCount&&(e+=` ${h.insertedCount} individu(s) inséré(s).`),h.updatedCount&&(e+=` ${h.updatedCount} individu(s) mis à jour.`),h.newCategoriesCreatedCount&&(e+=` ${h.newCategoriesCreatedCount} nouvelle(s) catégorie(s) créée(s).`),h.newFieldsAddedCount&&(e+=` ${h.newFieldsAddedCount} nouveau(x) champ(s) ajouté(s) aux catégories.`),h.errorCount>0||h.errors&&h.errors.length>0){const r=(h.errors||[]).join("\n- ");e+=`\n${h.errorCount||(h.errors||[]).length} erreur(s) lors du traitement des lignes/champs:\n- ${r}`,P({text:e,type:"warning"},2e4)}else P({text:e,type:"success"},1e4);U(4)}else{const e=h.errors&&h.errors.length>0?"\nDétails:\n- "+h.errors.join("\n- "):"";P({text:`Erreur lors de l'import (réponse API): ${h.error||"Problème inconnu"}${e}`,type:"error"},2e4)}Y(!1)}catch(p){let e=`Erreur lors de l'importation: ${p.message}`;P({text:e,type:"error"},15e3),Y(!1)}},ze=()=>{U(1),Z(null),W(""),Q(null),D({}),F({});const e={};J&&J.rawHeaders&&J.rawHeaders.forEach((r=>{e[r]={categorie_id:w.length>0?w[0].id.toString():"",newCategorieNom:"",label:r,key:r.toLowerCase().replace(/[^a-z0-9_]/g,"_").substring(0,50)||`champ_${Date.now()}`,type:"text",obligatoire:!1,visible:!0,readonly:!1,afficherEnTete:!1,options:[],maxLength:null,ordre:0}})),O(e),ue(""),me(!1),N.current&&(N.current.value=""),P({text:"",type:"info"}),Y(!1),re(0),E(""),ie(!1),ae({host:"",port:1521,serviceName:"",username:"",password:"",query:""})},De=e=>{const r={},t={},a={};e.forEach((e=>{r[e]="map",a[e]="",t[e]={categorie_id:w.length>0?w[0].id.toString():"",newCategorieNom:"",label:e,key:e.toLowerCase().replace(/[^a-z0-9_]/g,"_").substring(0,50)||`champ_${Date.now()}`,type:"text",obligatoire:!1,visible:!0,readonly:!1,afficherEnTete:!1,options:[],maxLength:null,ordre:0}})),F(r),O(t),D(a),ue("")},Ae=()=>J?e.jsx(y,{data:J.rows.map(((e,r)=>{const t={};return J.headers.forEach(((r,a)=>{t[r]=e[a]})),t})),columns:J.headers.map((e=>({title:e,dataIndex:e,key:e}))),loading:K,error:error,onLoadData:()=>Promise.resolve(J.rows),refreshInterval:null,maxRetries:0}):null,Fe=()=>{switch(B){case 1:return e.jsx("div",{className:"wizard-panel-content",children:e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"file-upload-input",children:"Sélectionner un fichier (CSV, XLS, XLSX):"}),e.jsx("input",{id:"file-upload-input",type:"file",accept:".csv,.xls,.xlsx",ref:N,onChange:ke,className:"file-input stylish-input",disabled:K}),e.jsx("p",{className:"help-text",children:"Le fichier doit contenir une ligne d'en-tête."})]})});case 2:return J?e.jsxs("div",{className:"wizard-panel-content",children:[e.jsx("h3",{children:"Identification du numéro d'individu"}),e.jsx("p",{className:"help-text important",children:'Sélectionnez la colonne du fichier qui contient le numéro unique d\'individu. Ce champ sera mappé à "numero_unique" dans la base de données.'}),e.jsxs("div",{className:"preview-container",children:[e.jsx("h4",{children:"Aperçu des données"}),Ae()]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"numero-individu-select",children:"Colonne pour le numéro d'individu:"}),e.jsx(x,{id:"numero-individu-select",value:de,onChange:e=>ue(e.target.value),options:[{value:"",label:"-- Sélectionnez --"},...J.rawHeaders.map((e=>({value:e,label:e})))],required:!0})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx(DattaCheckbox,{id:"create-if-missing",label:"Créer un individu si le numéro est manquant dans la base de données",checked:pe,onChange:e=>me(e.target.checked)}),e.jsx("p",{className:"help-text",children:"Si coché, les lignes avec un numéro unique non trouvé en base seront créées. Sinon, elles pourraient être ignorées ou mises à jour si le numéro existe."})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx(d,{variant:"secondary",onClick:ze,children:"Retour"}),e.jsx(d,{variant:"primary",onClick:$e,disabled:!de,children:"Continuer"})]})]}):e.jsx("div",{className:"loading",children:"Chargement de l'aperçu..."});case 3:return J?e.jsxs("div",{className:"wizard-panel-content",children:[e.jsx("h3",{children:"Configuration du mapping des colonnes"}),e.jsxs("div",{className:"preview-container",style:{marginBottom:"var(--spacing-5)"},children:[e.jsx("h4",{children:"Aperçu des données (rappel)"}),Ae()]}),e.jsxs("div",{className:"template-section",style:{marginBottom:"var(--spacing-5)",border:"1px solid var(--current-border-light)",padding:"var(--spacing-4)",borderRadius:"var(--border-radius-md)"},children:[e.jsx("h4",{children:"Gestion des templates de mapping"}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"load-template-select",children:"Charger un template:"}),e.jsxs("div",{style:{display:"flex",gap:"var(--spacing-3)",alignItems:"center"},children:[e.jsxs("select",{id:"load-template-select",className:"stylish-input select-stylish",value:I,onChange:e=>E(e.target.value),children:[e.jsx("option",{value:"",children:"-- Sélectionner un template --"}),$.map((r=>e.jsx("option",{value:r.name,children:r.name},r.name)))]}),e.jsx(d,{type:"button",variant:"secondary",size:"sm",onClick:()=>(e=>{const r=$.find((r=>r.name===e));r?(F(r.columnActions||{}),D(r.mapping||{}),O(r.nouveauxChamps||{}),E(e),P({text:`Template "${e}" chargé.`,type:"success"})):P({text:`Template "${e}" non trouvé.`,type:"error"})})(I),disabled:!I,children:"Charger"}),I&&e.jsx(d,{type:"button",variant:"danger",size:"sm",onClick:()=>(e=>{if(!confirm(`Êtes-vous sûr de vouloir supprimer le template "${e}" ?`))return;const r=$.filter((r=>r.name!==e));q(r),localStorage.setItem("importMappingTemplates",JSON.stringify(r)),I===e&&E(""),P({text:`Template "${e}" supprimé.`,type:"success"})})(I),title:"Supprimer ce template",children:"Supprimer"})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"save-template-input",children:"Enregistrer le mapping actuel comme template:"}),e.jsxs("div",{style:{display:"flex",gap:"var(--spacing-3)"},children:[e.jsx("input",{id:"save-template-input",type:"text",className:"stylish-input",value:L,onChange:e=>T(e.target.value),placeholder:"Nom du nouveau template"}),e.jsx(d,{type:"button",variant:"primary",size:"sm",onClick:Ee,disabled:!L.trim(),children:"Sauvegarder"})]})]})]}),e.jsx("div",{className:"mapping-form-container",children:J.rawHeaders.map((r=>e.jsxs("div",{className:"mapping-field-row "+(r===de?"special-field-row":""),children:[e.jsx("div",{className:"mb-3 mapping-source",children:e.jsxs("label",{children:["Colonne du fichier: ",e.jsx("strong",{children:r})]})}),r===de?e.jsx("div",{className:"special-mapping",children:e.jsxs("p",{children:["Mappée à : ",e.jsx("strong",{children:"Numéro d'individu (numero_unique)"})," (Obligatoire)"]})}):e.jsxs("div",{className:"mapping-options",children:[e.jsxs("div",{className:"radio-group",children:[e.jsxs("label",{children:[e.jsx("input",{type:"radio",name:`action-${r}`,value:"map",checked:"map"===A[r],onChange:()=>qe(r,"map")}),"Mapper à un champ existant"]}),e.jsxs("label",{children:[e.jsx("input",{type:"radio",name:`action-${r}`,value:"create",checked:"create"===A[r],onChange:()=>qe(r,"create")}),"Créer un nouveau champ"]}),e.jsxs("label",{children:[e.jsx("input",{type:"radio",name:`action-${r}`,value:"ignore",checked:"ignore"===A[r],onChange:()=>qe(r,"ignore")}),"Ignorer cette colonne"]})]}),"map"===A[r]&&e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:`target-${r}`,children:"Champ de destination DB:"}),e.jsxs("select",{id:`target-${r}`,className:"stylish-input select-stylish",value:z[r]||"",onChange:e=>((e,r)=>{D((t=>({...t,[e]:r})))})(r,e.target.value),children:[e.jsx("option",{value:"",children:"-- Sélectionner --"}),e.jsx("optgroup",{label:"Champs système",children:_.filter((e=>"Système"===e.categorieNom)).map((r=>e.jsx("option",{value:r.key,children:r.label},r.key)))}),w.map((r=>{const t=_.filter((e=>e.categorieId===r.id));return 0===t.length?null:e.jsx("optgroup",{label:r.nom,children:t.map((r=>e.jsx("option",{value:r.key,children:r.label},r.key)))},r.id)}))]})]}),"create"===A[r]&&R[r]&&e.jsxs("div",{className:"nouveau-champ-config",children:[e.jsx("h5",{children:"Configuration du nouveau champ"}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:`cat-${r}`,children:"Catégorie:"}),e.jsxs("select",{id:`cat-${r}`,className:"stylish-input select-stylish",value:R[r].categorie_id||"",onChange:e=>Ie(r,"categorie_id",e.target.value),required:!0,children:[e.jsx("option",{value:"",children:"-- Sélectionner catégorie --"}),w.map((r=>e.jsx("option",{value:r.id,children:r.nom},r.id))),e.jsx("option",{value:"__new__",children:"-- Nouvelle catégorie --"})]}),"__new__"===R[r].categorie_id&&e.jsx("input",{type:"text",className:"stylish-input",placeholder:"Nom nouvelle catégorie",value:R[r].newCategorieNom||"",onChange:e=>Ie(r,"newCategorieNom",e.target.value),style:{marginTop:"var(--spacing-2)"}})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:`label-${r}`,children:"Libellé:"}),e.jsx("input",{id:`label-${r}`,type:"text",className:"stylish-input",value:R[r].label||"",onChange:e=>Ie(r,"label",e.target.value),required:!0})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:`key-${r}`,children:"Clé technique (auto-générée, modifiable):"}),e.jsx("input",{id:`key-${r}`,type:"text",className:"stylish-input",value:R[r].key||"",onChange:e=>Ie(r,"key",e.target.value.replace(/[^a-zA-Z0-9_]/g,"_").toLowerCase()),pattern:"[a-zA-Z0-9_]+",title:"Lettres, chiffres, underscores",required:!0})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:`type-${r}`,children:"Type:"}),e.jsx("select",{id:`type-${r}`,className:"stylish-input select-stylish",value:R[r].type||"text",onChange:e=>Ie(r,"type",e.target.value),children:C.map((r=>e.jsx("option",{value:r.value,children:r.label},r.value)))})]}),"text"===R[r].type&&e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:`maxLength-${r}`,children:"Longueur Max:"}),e.jsx("input",{id:`maxLength-${r}`,type:"number",className:"stylish-input",value:R[r].maxLength||"",onChange:e=>Ie(r,"maxLength",e.target.value?parseInt(e.target.value):null),min:"1"})]}),"list"===R[r].type&&e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:`options-${r}`,children:"Options (séparées par virgule):"}),e.jsx("input",{id:`options-${r}`,type:"text",className:"stylish-input",value:(R[r].options||[]).join(","),onChange:e=>((e,r)=>{const t=r.split(",").map((e=>e.trim())).filter((e=>""!==e));Ie(e,"options",t)})(r,e.target.value)})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:`ordre-champ-${r}`,children:"Ordre du champ dans sa catégorie:"}),e.jsx("input",{id:`ordre-champ-${r}`,type:"number",className:"stylish-input",value:R[r].ordre||0,onChange:e=>Ie(r,"ordre",parseInt(e.target.value,10)||0),min:"0"})]}),e.jsxs("div",{className:"champ-options-checkboxes",children:[e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:R[r].obligatoire||!1,onChange:e=>Ie(r,"obligatoire",e.target.checked)})," Obligatoire"]}),e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:void 0===R[r].visible||R[r].visible,onChange:e=>Ie(r,"visible",e.target.checked)})," Visible"]}),e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:R[r].afficherEnTete||!1,onChange:e=>Ie(r,"afficherEnTete",e.target.checked)})," Afficher en en-tête"]})]})]}),"ignore"===A[r]&&e.jsx("p",{className:"help-text",children:"Cette colonne sera ignorée."})]})]},r)))}),e.jsxs("div",{className:"form-actions",children:[e.jsx(d,{variant:"secondary",onClick:()=>U(2),disabled:K,children:"Retour"}),e.jsx(d,{variant:"primary",onClick:Te,disabled:K,children:K?"Importation en cours...":"Lancer l'importation"})]})]}):e.jsx("div",{className:"loading",children:"Chargement..."});case 4:return e.jsx("div",{className:"wizard-panel-content",children:e.jsxs("div",{className:"import-results",children:[e.jsx("h3",{children:"Importation Terminée"}),e.jsx(d,{variant:"primary",onClick:ze,children:"Effectuer un nouvel import"})]})});default:return e.jsx("p",{children:"Étape inconnue."})}};return e.jsxs("div",{className:"pc-content",children:[e.jsx(u,{title:"Importation de données individus"}),e.jsxs(h,{className:"import-wizard",children:[M.text&&e.jsx(c,{type:M.type||"info",children:e.jsx("pre",{style:{whiteSpace:"pre-wrap",margin:0,fontFamily:"inherit"},children:M.text})}),e.jsxs(p,{value:H,onChange:(e,r)=>(V(r),U(1),Q(null),Z(null),W(""),void ie(!1)),children:[e.jsx(m,{label:"Depuis un fichier",value:"file"}),e.jsx(m,{label:"Depuis Oracle",value:"oracle"})]}),"file"===H?e.jsx(b,{activeStep:B-1,children:["Fichier","N° Individu","Mapping","Résultats"].map((r=>e.jsx(j,{disabled:"N° Individu"===r&&!X||"Mapping"===r&&!de||"Résultats"===r&&B<4,children:e.jsx(f,{children:r})},r)))}):e.jsx(b,{activeStep:B-1,children:["Configuration","Requête","Mapping","Résultats"].map((r=>e.jsx(j,{children:e.jsx(f,{children:r})},r)))}),e.jsxs("div",{className:"wizard-content",children:[K&&B>1&&B<4&&e.jsxs("div",{className:"position-fixed top-0 bottom-0 start-0 end-0 d-flex flex-column align-items-center justify-content-center bg-white bg-opacity-75",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("div",{className:"progress",role:"progressbar","aria-valuenow":ee,"aria-valuemin":"0","aria-valuemax":"100",children:e.jsx("div",{className:"progress-bar progress-bar-striped progress-bar-animated",style:{width:`${ee}%`}})}),e.jsx("div",{children:`Traitement... ${ee}%`})]}),(!K||1===B||4===B)&&("file"===H?Fe():1===B?e.jsxs("div",{className:"wizard-panel-content",children:[e.jsx("div",{className:"import-mode-selection mb-4",children:e.jsxs("div",{className:"btn-group",role:"group",children:[e.jsxs("button",{type:"button",className:"btn "+("manual"===he?"btn-primary":"btn-outline-primary"),onClick:()=>xe("manual"),children:[e.jsx("i",{className:"feather icon-edit me-2"}),"Import manuel"]}),e.jsxs("button",{type:"button",className:"btn "+("preset"===he?"btn-primary":"btn-outline-primary"),onClick:()=>{xe("preset"),Le()},children:[e.jsx("i",{className:"feather icon-zap me-2"}),"Import rapide"]})]})}),"preset"===he?e.jsxs("div",{className:"preset-mode",children:[e.jsx("h4",{children:"Imports rapides"}),e.jsx("p",{className:"text-muted",children:"Exécutez des imports préconfigurés ou modifiez-les avant exécution."}),0===ge.length?e.jsxs("div",{className:"text-center py-4",children:[e.jsx("i",{className:"feather icon-inbox mb-3",style:{fontSize:"3rem",opacity:.5}}),e.jsx("h5",{children:"Aucun preset disponible"}),e.jsx("p",{children:"Créez votre premier preset en configurant un import manuel."})]}):e.jsx("div",{className:"presets-grid",children:ge.map((t=>e.jsxs("div",{className:"preset-card",children:[e.jsxs("div",{className:"preset-header",children:[e.jsx("h6",{children:t.name}),e.jsx("span",{className:"badge bg-info",children:t.configName})]}),t.description&&e.jsx("p",{className:"preset-description",children:t.description}),e.jsx("div",{className:"preset-info",children:e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"feather icon-database me-1"}),t.configInfo]})}),e.jsx("div",{className:"preset-query",children:e.jsx("small",{children:e.jsxs("code",{children:[t.query.substring(0,100),"..."]})})}),e.jsxs("div",{className:"preset-actions mt-3",children:[e.jsxs(d,{variant:"primary",size:"sm",onClick:()=>(async e=>{Y(!0),re(0);try{const t=await window.api.executeOraclePreset(e,r.id);if(t.success){let e="Import preset exécuté avec succès !";t.insertedCount&&(e+=` ${t.insertedCount} individu(s) inséré(s).`),t.updatedCount&&(e+=` ${t.updatedCount} individu(s) mis à jour.`),P({text:e,type:"success"}),U(4)}else P({text:t.error,type:"error"})}catch(t){P({text:t.message,type:"error"})}finally{Y(!1)}})(t.id),disabled:K,children:[e.jsx("i",{className:"feather icon-play me-1"}),"Exécuter"]}),e.jsxs(d,{variant:"outline-primary",size:"sm",onClick:()=>{(async e=>{try{const t=await window.api.getOracleImportPreset(e,r.id);if(t.success){const e=t.data;ce(e.configId),ae((r=>({...r,query:e.query}))),D(e.mapping),F(e.columnActions),O(e.nouveauxChamps),ue(e.numeroIndividuHeader),me(e.createIfMissing),fe(e),P({text:`Preset "${e.name}" chargé !`,type:"success"})}}catch(t){P({text:t.message,type:"error"})}})(t.id),xe("manual"),U(2)},children:[e.jsx("i",{className:"feather icon-edit me-1"}),"Modifier"]}),e.jsx(d,{variant:"outline-danger",size:"sm",onClick:()=>(async e=>{if(confirm("Supprimer ce preset ?"))try{const t=await window.api.deleteOracleImportPreset(e,r.id);t.success?(P({text:"Preset supprimé.",type:"success"}),Le()):P({text:t.error,type:"error"})}catch(t){P({text:t.message,type:"error"})}})(t.id),children:e.jsx("i",{className:"feather icon-trash-2"})})]})]},t.id)))})]}):e.jsxs("div",{className:"wizard-panel-content",children:[e.jsx(g,{label:"Serveur",value:te.host,onChange:e=>ae((r=>({...r,host:e.target.value}))),required:!0}),e.jsx(g,{type:"number",label:"Port",value:te.port,onChange:e=>ae((r=>({...r,port:parseInt(e.target.value,10)})))}),e.jsx(g,{label:"Service Name / SID",value:te.serviceName,onChange:e=>ae((r=>({...r,serviceName:e.target.value}))),required:!0}),e.jsx(g,{label:"Nom d'utilisateur",value:te.username,onChange:e=>ae((r=>({...r,username:e.target.value}))),required:!0}),e.jsx(g,{type:"password",label:"Mot de passe",value:te.password,onChange:e=>ae((r=>({...r,password:e.target.value}))),required:!0}),e.jsxs("div",{className:"form-actions",children:[e.jsx(d,{variant:"primary",onClick:async()=>{Y(!0);try{const e=await window.api.testOracleConnection(te);e.success?(P({text:e.message||"Connexion réussie",type:"success"}),ie(!0)):(P({text:e.error||"Erreur de connexion",type:"error"}),ie(!1))}catch(e){P({text:e.message,type:"error"}),ie(!1)}finally{Y(!1)}},disabled:K,children:K?"Test en cours...":"Tester la connexion"}),se&&e.jsx(d,{variant:"success",onClick:()=>U(2),children:"Continuer"})]})]})]}):2===B?e.jsxs("div",{className:"wizard-panel-content",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{children:"Requête SQL Oracle"}),e.jsx("textarea",{className:"form-control",rows:"10",value:te.query,onChange:e=>ae((r=>({...r,query:e.target.value})))})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx(d,{variant:"secondary",onClick:()=>U(1),children:"Retour"}),e.jsx(d,{variant:"primary",onClick:async()=>{const e=(e=>{const r=e.toUpperCase().trim();return r.startsWith("SELECT")?["DROP","DELETE","INSERT","UPDATE","CREATE","ALTER","TRUNCATE"].some((e=>r.includes(e)))?{valid:!1,error:"Requête potentiellement dangereuse détectée"}:{valid:!0}:{valid:!1,error:"Seules les requêtes SELECT sont autorisées"}})(te.query);if(e.valid){Y(!0);try{const e=await window.api.executeOracleQuery({config:te,query:te.query,maxRows:1e3});if(e.success){const t={source:"oracle",headers:(r=e.data).metaData.map((e=>e.name)),rows:r.rows.slice(0,5),rawHeaders:r.metaData.map((e=>e.name)),totalRows:r.rows.length,oracleMetadata:r.metaData};Q(t),De(t.rawHeaders),U(3)}else P({text:e.error||"Erreur exécution requête",type:"error"})}catch(t){P({text:t.message,type:"error"})}finally{Y(!1)}var r}else P({text:e.error,type:"error"})},disabled:!te.query.trim()||K,children:K?"Exécution...":"Exécuter et prévisualiser"})]})]}):3===B?e.jsxs("div",{className:"wizard-panel-content",children:[Fe(),"oracle"!==H||3!==B?null:e.jsx("div",{className:"save-preset-section mt-3",children:e.jsxs(d,{variant:"outline-success",onClick:()=>be(!0),disabled:!oe||!te.query||!de,children:[e.jsx("i",{className:"feather icon-save me-2"}),"Sauvegarder comme preset"]})}),e.jsx(v,{open:je,onClose:()=>be(!1),title:"Sauvegarder comme preset",size:"md",children:e.jsxs("form",{onSubmit:e=>{e.preventDefault(),(async()=>{if(!Ce.trim())return void P({text:"Veuillez donner un nom au preset.",type:"error"});const e={name:Ce.trim(),description:we.trim(),configId:oe,query:te.query,mapping:z,columnActions:A,nouveauxChamps:R,numeroIndividuHeader:de,createIfMissing:pe};try{const t=await window.api.saveOracleImportPreset(e,r.id);t.success?(P({text:`Preset "${Ce}" sauvegardé !`,type:"success"}),be(!1),Ne(""),Se(""),Le()):P({text:t.error,type:"error"})}catch(t){P({text:t.message,type:"error"})}})()},children:[e.jsx("div",{className:"mb-3",children:e.jsx(g,{label:"Nom du preset *",value:Ce,onChange:e=>Ne(e.target.value),required:!0,placeholder:"Exemple : import mensuel RH"})}),e.jsx("div",{className:"mb-3",children:e.jsx(g,{label:"Description",value:we,onChange:e=>Se(e.target.value),placeholder:"Description optionnelle",multiline:!0,rows:3})}),e.jsxs("div",{className:"preset-summary",children:[e.jsx("h6",{children:"Résumé de la configuration :"}),e.jsxs("ul",{children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Configuration :"})," ",null==(Re=ne.find((e=>e.id===parseInt(oe))))?void 0:Re.name]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Colonnes mappées :"})," ",Object.keys(z).filter((e=>z[e])).length]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Nouveaux champs :"})," ",Object.keys(A).filter((e=>"create"===A[e])).length]})]})]}),e.jsxs("div",{className:"d-flex justify-content-end gap-2",children:[e.jsx(d,{type:"button",variant:"secondary",onClick:()=>be(!1),children:"Annuler"}),e.jsx(d,{type:"submit",variant:"primary",children:"Sauvegarder"})]})]})})]}):Fe())]})]})]});var Re}export{N as default};
