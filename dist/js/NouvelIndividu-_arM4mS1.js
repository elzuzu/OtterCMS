import{j as e}from"./vendor-ui-CtvHukzg.js";import{r as a}from"./vendor-data-BY55b65u.js";import{a as s,D as r}from"./main-BtLJocfP.js";import{D as t}from"./DattaCard-Ca8oAgyz.js";import{e as i}from"./dynamic-D4zAvdYy.js";import{D as n,a as o}from"./DattaForm-CDg-NNVW.js";import{D as l}from"./DattaPageTitle-T82UHXFU.js";import{D as c}from"./DattaCheckbox-DNdiamZ9.js";import{D as d,T as u}from"./DattaTabs-D7AxHKPN.js";import"./vendor-react-DjGYZWH8.js";function m({user:m,onClose:h,onSuccess:p}){const[g,v]=a.useState([]),[b,j]=a.useState([]),[x,f]=a.useState(""),[y,N]=a.useState(""),[k,C]=a.useState({}),[$,S]=a.useState(null),[w,D]=a.useState(""),[I,q]=a.useState(!1),[E,L]=a.useState(!0),P=a.useCallback((async()=>{L(!0);try{const[e,a]=await Promise.all([window.api.getCategories(),"admin"===m.role||"manager"===m.role?window.api.getUsers():Promise.resolve({success:!0,data:[m]})]);if(e.success){const a=[...e.data||[]].filter((e=>1!==e.deleted)).sort(((e,a)=>(e.ordre||0)-(a.ordre||0)));v(a),a.length>0&&S(`cat-${a[0].id}`)}else v([]),D("Erreur chargement catégories: "+(e.error||"Inconnue"));a.success?j(a.data||[]):(j("admin"===m.role||"manager"===m.role?[]:[m]),D((e=>e+(e?"; ":"")+"Erreur chargement utilisateurs: "+(a.error||"Inconnue")))),N(String(m.id||m.userId||""))}catch(e){D(`Erreur critique au chargement: ${e.message}`)}finally{L(!1)}}),[m]);a.useEffect((()=>{P()}),[P]);const T=(e,a)=>{C((s=>({...s,[e]:a})))},_=async(e,a=!1)=>{if(e.preventDefault(),D(""),x.trim()){for(const e of g)for(const a of e.champs||[])if(a.visible&&a.obligatoire&&!a.readonly){const s=k[a.key];if(null==s||""===String(s).trim()){if("checkbox"!==a.type)return D(`Le champ "${a.label}" dans la catégorie "${e.nom}" est obligatoire.`),void S(`cat-${e.id}`);if(!s)return D(`Le champ "${a.label}" dans la catégorie "${e.nom}" est obligatoire et doit être coché.`),void S(`cat-${e.id}`)}}q(!0);try{const e={numero_unique:x.trim(),en_charge:y?Number(y):null,champs_supplementaires:k},s=await window.api.addOrUpdateIndividu({individu:e,userId:m.id||m.userId,isImport:!1});s.success?(D("Individu ajouté avec succès!"),p&&p(),f(""),N(a&&y?y:String(m.id||m.userId||"")),C({}),g.length>0&&S(`cat-${g[0].id}`),a?setTimeout((()=>{D("")}),2500):setTimeout((()=>{D(""),h&&h()}),1500)):D("Erreur: "+(s.error||"Problème inconnu"))}catch(s){D(`Erreur: ${s.message}`)}finally{q(!1)}}else D("Le numéro d'individu est obligatoire.")},z=a=>{const s={id:`champ-new-${a.key}`,label:`${a.label}${a.obligatoire?" *":""}`,value:k[a.key]??"",onChange:e=>T(a.key,"checkbox"===a.type?e.target.checked:e.target.value),required:a.obligatoire&&!a.readonly,disabled:a.readonly};switch(a.type){case"text":return e.jsx(n,{...s,maxLength:a.maxLength});case"number":case"number-graph":return e.jsx(n,{...s,type:"number"});case"date":return e.jsx(n,{...s,type:"date"});case"list":return e.jsx(o,{...s,options:(a.options||[]).map((e=>({value:e,label:e})))});case"checkbox":return e.jsx(c,{id:s.id,label:a.label,checked:!!k[a.key],onChange:e=>T(a.key,e.target.checked),disabled:a.readonly});case"dynamic":{const s={...k,numero_unique:x,en_charge:y},r=i(a.formule,s);return e.jsx("span",{className:"form-value-display",children:r??""})}default:return e.jsx(n,{...s})}};return E?e.jsxs("div",{className:"pc-content",children:[e.jsx(l,{title:"Nouvel individu"}),e.jsx(t,{children:e.jsx("div",{className:"text-center py-4",children:"Chargement de la configuration..."})})]}):e.jsxs("div",{className:"pc-content",children:[e.jsx(l,{title:"Nouvel individu"}),w&&e.jsx(s,{type:w.includes("succès")?"success":"danger",dismissible:!0,onClose:()=>D(""),className:"mb-3",children:w}),e.jsx("form",{onSubmit:e=>_(e,!1),children:e.jsxs(t,{title:"Informations principales",actions:e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(r,{type:"submit",variant:"success",size:"sm",disabled:I,children:I?"Création...":"Enregistrer et Fermer"}),e.jsx(r,{type:"button",variant:"primary",size:"sm",onClick:e=>{_(e,!0)},disabled:I,children:I?"Création...":"Enregistrer et Nouveau"}),h&&e.jsx(r,{type:"button",variant:"secondary",size:"sm",onClick:h,disabled:I,children:"Annuler"})]}),children:[e.jsxs("div",{className:"row mb-4",children:[e.jsx("div",{className:"col-md-6",children:e.jsx(n,{id:"numeroUnique",label:"Numéro d'individu (unique) *",value:x,onChange:e=>f(e.target.value),required:!0})}),e.jsx("div",{className:"col-md-6",children:e.jsx(o,{id:"enCharge",label:"Personne en charge",value:y,onChange:e=>N(e.target.value),options:[{value:"",label:"Non assigné"},...b.map((e=>({value:String(e.id),label:e.username})))]})})]}),e.jsx(d,{value:$,onChange:(e,a)=>S(a),children:g.map((a=>e.jsx(u,{label:a.nom,value:`cat-${a.id}`},`tab-${a.id}`)))}),g.map((a=>{if($!==`cat-${a.id}`)return null;const s=a.champs?a.champs.filter((e=>e.visible&&!e.readonly)):[];return e.jsx(t,{title:a.nom,className:"mt-3",children:e.jsx("div",{className:"row",children:s.sort(((e,a)=>(e.ordre||0)-(a.ordre||0))).map((a=>e.jsx("div",{className:"col-md-6 mb-3",children:z(a)},a.key)))})},`content-${a.id}`)})),0===g.length&&e.jsx("div",{className:"text-muted",children:"Aucune catégorie active disponible. Veuillez créer ou démasquer au moins une catégorie avant d'ajouter des individus."})]})})]})}export{m as default};
