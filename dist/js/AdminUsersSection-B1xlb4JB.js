import{j as e}from"./vendor-ui-CtvHukzg.js";import{r as s}from"./vendor-data-BY55b65u.js";import{D as a}from"./DattaNetworkDataTable-CKoFfAgq.js";import{u as r,a as i,D as n}from"./main-BtLJocfP.js";import{D as t}from"./DattaCard-Ca8oAgyz.js";import{D as l,a as o}from"./DattaForm-CDg-NNVW.js";import{h as c}from"./WindowControls-nBMnr5hL.js";import{D as d}from"./DattaPageTitle-T82UHXFU.js";import"./vendor-react-DjGYZWH8.js";const u=s=>e.jsx("i",{className:"feather icon-edit",...s}),m=s=>e.jsx("i",{className:"feather icon-trash",...s});function p(){const[c,d]=s.useState([]),[p,j]=s.useState({username:"",password:"",role:"user",windows_login:""}),[w,h]=s.useState(""),[x,v]=s.useState(!1),[g,f]=s.useState(null),[b,y]=s.useState(""),[N,k]=s.useState(null),{performSync:C}=r(),S=s.useCallback((async()=>{try{const e=await window.api.getUsers();if(e.success)d(e.data),k(null),await C();else{const s=e.error||"Problème lors du chargement des utilisateurs";k(s),h(`Erreur: ${s}`)}}catch(e){k(e.message),h(`Erreur critique: ${e.message}`)}}),[C]);s.useEffect((()=>{S()}),[S]);const E=e=>{const{name:s,value:a}=e.target;j({...p,[s]:a})},P=c.filter((e=>e.username.toLowerCase().includes(b.toLowerCase())||(e.windows_login||"").toLowerCase().includes(b.toLowerCase())));return e.jsxs(e.Fragment,{children:[w&&e.jsx(i,{type:w.includes("succès")?"success":"danger",className:"mb-3",children:w}),e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-xl-4 col-md-12",children:e.jsx(t,{title:g?"Modifier un utilisateur":"Ajouter un utilisateur",children:e.jsxs("form",{onSubmit:async e=>{e.preventDefault();try{if(v(!0),h(""),!p.username||!p.password&&!g)return h("Le nom d'utilisateur et le mot de passe sont obligatoires pour un nouvel utilisateur."),void v(!1);let e=p.windows_login;e&&e.includes("\\")&&(e=e.split("\\").pop());const s={...p,windows_login:e};let a;a=g?await window.api.updateUser({...s,id:g.id}):await window.api.createUser(s),a.success?(h(g?"Utilisateur mis à jour avec succès!":"Utilisateur créé avec succès!"),j({username:"",password:"",role:"user",windows_login:""}),f(null),S()):h(`Erreur: ${a.error||"Problème inconnu"}`)}catch(s){h(`Erreur: ${s.message}`)}finally{v(!1)}},children:[e.jsx(l,{label:"Nom d'utilisateur",name:"username",value:p.username,onChange:E,required:!0}),e.jsx(l,{type:"password",label:"Mot de passe "+(g?"(laisser vide pour ne pas changer)":""),name:"password",value:p.password,onChange:E,required:!g}),e.jsx(o,{label:"Rôle",name:"role",value:p.role,onChange:E,options:[{value:"user",label:"Utilisateur"},{value:"manager",label:"Manager"},{value:"admin",label:"Administrateur"}]}),e.jsx(l,{label:"Login Windows (sans domaine)",name:"windows_login",value:p.windows_login,onChange:E,placeholder:"Nom d'utilisateur Windows sans domaine"}),e.jsxs("div",{className:"form-actions",children:[e.jsx(n,{type:"submit",variant:"primary",disabled:x,children:x?"En cours...":g?"Mettre à jour":"Ajouter"}),g&&e.jsx(n,{type:"button",onClick:()=>{f(null),j({username:"",password:"",role:"user",windows_login:""})},variant:"secondary",children:"Annuler"})]})]})})}),e.jsx("div",{className:"col-xl-8 col-md-12",children:e.jsx(t,{children:e.jsxs("div",{className:"card-body",children:[e.jsx("div",{className:"d-flex justify-content-between align-items-center mb-3",children:e.jsx(l,{type:"search",placeholder:"Rechercher un utilisateur...",value:b,onChange:e=>y(e.target.value),className:"form-control-sm"})}),e.jsx(a,{data:P,columns:[{title:"Nom d'utilisateur",dataIndex:"username",key:"username",sorter:!0},{title:"Rôle",dataIndex:"role",key:"role",sorter:!0,render:e=>({user:"Utilisateur",manager:"Manager",admin:"Administrateur"}[e]||e)},{title:"Login Windows",dataIndex:"windows_login",key:"windows_login",sorter:!0},{title:"Actions",key:"actions",render:(s,a)=>e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(n,{variant:"outline-primary",size:"sm",onClick:()=>{return f(e=a),void j({username:e.username,password:"",role:e.role,windows_login:e.windows_login||""});var e},children:e.jsx(u,{})}),e.jsx(n,{variant:"outline-danger",size:"sm",onClick:()=>(async e=>{if(window.confirm("Êtes-vous sûr de vouloir supprimer cet utilisateur?"))try{v(!0);const s=await window.api.deleteUser(e);s.success?(h("Utilisateur supprimé avec succès!"),S()):h(`Erreur: ${s.error||"Problème inconnu"}`)}catch(s){h(`Erreur: ${s.message}`)}finally{v(!1)}})(a.id),children:e.jsx(m,{})})]})}],loading:x,error:N,onLoadData:S,refreshInterval:3e4,maxRetries:3,pagination:{currentPage:1,itemsPerPage:10,totalItems:P.length}})]})})})]})]})}function j({user:d}){const[p,j]=s.useState([]),[w,h]=s.useState({name:"",permissions:[]}),[x,v]=s.useState(""),[g,f]=s.useState(!1),[b,y]=s.useState(null),[N,k]=s.useState(null),{performSync:C}=r(),S=s.useCallback((async()=>{try{const e=await window.api.getRoles();if(e.success)j(e.data),k(null),await C();else{const s=e.error||"Problème lors du chargement des rôles";k(s),v(`Erreur: ${s}`)}}catch(e){k(e.message),v(`Erreur critique: ${e.message}`)}}),[C]);s.useEffect((()=>{S()}),[S]);const E=()=>{y(null),h({name:"",permissions:[]})},P=e=>{const{name:s,value:a,type:r,checked:i}=e.target;h((e=>({...e,[s]:"checkbox"===r?i?[a]:[]:a})))};return c(d,"manage_roles")?e.jsxs(e.Fragment,{children:[x&&e.jsx(i,{type:x.includes("succès")?"success":"danger",className:"mb-3",children:x}),e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-xl-4 col-md-12",children:e.jsx(t,{title:b?"Modifier un rôle":"Ajouter un rôle",children:e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),!window.api)return void v("API indisponible");const s={name:w.name,permissions:w.permissions};try{const e=b?await window.api.updateRole(s):await window.api.createRole(s);e.success?(v("Role sauvegardé"),S(),E()):v(e.error||"Erreur")}catch(a){v(a.message||"Erreur")}},children:[e.jsx(l,{label:"Nom du rôle",name:"name",value:w.name,onChange:P,required:!0}),e.jsx(o,{label:"Permissions",name:"permissions",value:w.permissions,onChange:P,multiple:!0,options:[{value:"read",label:"Lecture"},{value:"write",label:"Écriture"},{value:"delete",label:"Suppression"},{value:"admin",label:"Administration"}]}),e.jsxs("div",{className:"form-actions",children:[e.jsx(n,{type:"submit",variant:"primary",disabled:g,children:g?"En cours...":b?"Mettre à jour":"Ajouter"}),b&&e.jsx(n,{type:"button",onClick:E,variant:"secondary",children:"Annuler"})]})]})})}),e.jsx("div",{className:"col-xl-8 col-md-12",children:e.jsx(t,{children:e.jsx("div",{className:"card-body",children:e.jsx(a,{data:p,columns:[{title:"Nom",dataIndex:"name",key:"name",sorter:!0},{title:"Permissions",dataIndex:"permissions",key:"permissions",render:e=>e.join(", ")},{title:"Actions",key:"actions",render:(s,a)=>e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(n,{variant:"outline-primary",size:"sm",onClick:()=>{return y(e=a),void h({name:e.name,permissions:e.permissions});var e},children:e.jsx(u,{})}),e.jsx(n,{variant:"outline-danger",size:"sm",onClick:()=>(async e=>{if(window.confirm("Supprimer ce rôle ?"))if(window.api&&window.api.deleteRole)try{const s=await window.api.deleteRole(e);s.success?S():v(s.error||"Erreur")}catch(s){v(s.message||"Erreur")}else v("API indisponible")})(a.name),children:e.jsx(m,{})})]})}],loading:g,error:N,onLoadData:S,refreshInterval:3e4,maxRetries:3,pagination:{currentPage:1,itemsPerPage:10,totalItems:p.length}})})})})]})]}):e.jsx("div",{children:"Accès refusé."})}function w({user:a}){const[r,i]=s.useState("users");return e.jsxs("div",{className:"pc-content",children:[e.jsx(d,{title:"Gestion des utilisateurs"}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("ul",{className:"nav nav-tabs card-header-tabs",children:[e.jsx("li",{className:"nav-item",children:e.jsxs("a",{className:"nav-link "+("users"===r?"active":""),onClick:()=>i("users"),role:"button",children:[e.jsx("i",{className:"feather icon-users me-2"}),"Utilisateurs"]})}),e.jsx("li",{className:"nav-item",children:e.jsxs("a",{className:"nav-link "+("roles"===r?"active":""),onClick:()=>i("roles"),role:"button",children:[e.jsx("i",{className:"feather icon-shield me-2"}),"Rôles"]})})]})}),e.jsx("div",{className:"card-body",children:"users"===r?e.jsx(p,{}):e.jsx(j,{user:a})})]})]})}export{w as default};
