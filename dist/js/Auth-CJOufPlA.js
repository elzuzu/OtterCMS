import{j as e}from"./vendor-ui-CtvHukzg.js";import{r as s}from"./vendor-data-BY55b65u.js";import{W as i,g as a}from"./WindowControls-nBMnr5hL.js";import{D as n,a as r}from"./main-BtLJocfP.js";import{D as t}from"./DattaForm-CDg-NNVW.js";import"./vendor-react-DjGYZWH8.js";function o({setUser:o}){const[d,c]=s.useState(""),[l,u]=s.useState(""),[m,p]=s.useState(""),[w,h]=s.useState(!1),[x,j]=s.useState(!1),[v,f]=s.useState(""),[g,_]=s.useState(!1);return s.useEffect((()=>{(async()=>{if(window.__TAURI__&&window.__TAURI__.invoke)try{h(!0);const e=await window.__TAURI__.invoke("get_windows_username");if(e&&e.success){let s=e.username;s&&s.includes("\\")&&(s=s.split("\\").pop());const i=await window.__TAURI__.invoke("auto_login_with_windows",{username:s});if(i&&i.success){const e={id:i.userId,userId:i.userId,username:i.username,role:i.role,permissions:i.permissions||a(i.role),windows_login:s};o(e)}}}catch(e){}finally{h(!1),_(!0)}else if(window.api)try{if(window.api.getWindowsUsername&&window.api.autoLoginWithWindows){h(!0);const e=await window.api.getWindowsUsername();if(e&&e.success){let s=e.username;s&&s.includes("\\")&&(s=s.split("\\").pop());const i=await window.api.autoLoginWithWindows(s);if(i&&i.success){const e={id:i.userId,userId:i.userId,username:i.username,role:i.role,permissions:i.permissions||a(i.role),windows_login:s};o(e)}}}}catch(e){}finally{h(!1),_(!0)}else p("Erreur critique : Le pont de communication (preload API) n'est pas chargé. L'application ne peut pas fonctionner."),_(!0)})()}),[o]),w&&!g?e.jsx("div",{className:"auth-main",children:e.jsx("div",{className:"auth-wrapper v1",children:e.jsxs("div",{className:"auth-form",children:[e.jsx(i,{}),e.jsxs("div",{className:"position-relative my-5",children:[e.jsxs("div",{className:"auth-bg",children:[e.jsx("span",{className:"r"}),e.jsx("span",{className:"r s"}),e.jsx("span",{className:"r s"}),e.jsx("span",{className:"r"})]}),e.jsx("div",{className:"card mb-0",children:e.jsxs("div",{className:"card-body text-center",children:[e.jsx("h6",{className:"mb-3",children:"Connexion automatique..."}),e.jsx("p",{children:"Tente de se connecter avec votre compte Windows..."})]})})]})]})})}):e.jsx("div",{className:"auth-main",children:e.jsx("div",{className:"auth-wrapper v1",children:e.jsxs("div",{className:"auth-form",children:[e.jsx(i,{}),e.jsxs("div",{className:"position-relative my-5",children:[e.jsxs("div",{className:"auth-bg",children:[e.jsx("span",{className:"r"}),e.jsx("span",{className:"r s"}),e.jsx("span",{className:"r s"}),e.jsx("span",{className:"r"})]}),e.jsxs("div",{className:"card mb-0",children:[e.jsx("div",{className:"card-header",children:e.jsx("h4",{className:"mb-3 f-w-400",children:"Connexion"})}),e.jsxs("div",{className:"card-body",children:[e.jsxs("form",{onSubmit:async e=>{e.preventDefault(),h(!0),p(""),f("");try{let e;if(window.__TAURI__&&window.__TAURI__.invoke)e=await window.__TAURI__.invoke("auth_login",{request:{username:d,password:l}});else{if(!window.api||!window.api.login)return p("Erreur: API de connexion non disponible. Le script preload n'est peut-être pas chargé."),void h(!1);e=await window.api.login(d,l)}if(e&&e.success){const s={id:e.userId,userId:e.userId,username:e.username,role:e.role,permissions:e.permissions||a(e.role),windows_login:e.windows_login};o(s)}else p((null==e?void 0:e.error)||"Identifiant ou mot de passe incorrect. Vérifiez également que la base de données est initialisée.")}catch(s){p(`Erreur de connexion: ${s.message}. Assurez-vous que l'application est correctement configurée.`)}finally{h(!1)}},children:[e.jsx(t,{id:"username",label:e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"feather icon-user me-1"})," Nom d'utilisateur"]}),value:d,onChange:e=>c(e.target.value),placeholder:"Entrez votre nom d'utilisateur",required:!0,autoFocus:!0}),e.jsx(t,{id:"password",type:"password",label:e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"feather icon-lock me-1"})," Mot de passe"]}),value:l,onChange:e=>u(e.target.value),placeholder:"Entrez votre mot de passe",required:!0}),e.jsx(n,{variant:"primary",className:"btn-block mb-4",type:"submit",loading:w||x,children:"Se connecter"}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem",justifyContent:"center"},children:[e.jsx(n,{variant:"secondary",onClick:async()=>{p(""),f("");try{if(window.api&&window.api.testConnection){const e=await window.api.testConnection();e&&e.success?p(`Test IPC réussi: ${e.message}`):p(`Test IPC échoué: ${e?e.message||e.error:"Réponse invalide"}`)}else p("Erreur: window.api.testConnection non trouvée. Le script preload n'est peut-être pas correctement chargé ou l'API n'est pas exposée.")}catch(e){p(`Erreur lors du test IPC: ${e.message}`)}},disabled:x,children:"Test IPC"}),e.jsx(n,{variant:"success",onClick:async()=>{j(!0),f("Initialisation de la base de données en cours..."),p("");try{if(!window.api||!window.api.initDatabase)return f("Erreur critique: La fonction d'initialisation de la base de données n'est pas disponible."),void j(!1);const e=await window.api.initDatabase();e.success?f("Base de données initialisée avec succès! Vous pouvez maintenant vous connecter avec:\nIdentifiant: admin\nMot de passe: admin"):f(`Échec de l'initialisation: ${e.error||"Erreur inconnue"}`)}catch(e){f(`Erreur lors de l'initialisation: ${e.message}`)}finally{j(!1)}},loading:x||w,children:x?"Initialisation...":"Initialiser la DB"})]})]}),m&&e.jsx(r,{type:"error",children:m}),v&&e.jsx(r,{type:v.includes("succès")?"success":"warning",children:v}),e.jsxs("p",{className:"small mt-3 help-text",children:["Identifiants par défaut après initialisation :",e.jsx("br",{}),"Utilisateur : ",e.jsx("strong",{children:"admin"})," | Mot de passe : ",e.jsx("strong",{children:"admin"}),e.jsx("br",{}),'Si vous rencontrez une erreur de base de données ou "User not found", essayez d\'abord "Initialiser la DB".']})]})]})]})]})})})}export{o as default};
