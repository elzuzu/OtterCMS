import{j as e}from"./vendor-ui-CtvHukzg.js";import{r as s}from"./vendor-data-BY55b65u.js";import{D as i}from"./DattaCard-Ca8oAgyz.js";import{D as n,u as a}from"./main-BtLJocfP.js";import{f as t}from"./date-BJLw6yVC.js";import r from"./NouvelIndividu-_arM4mS1.js";import{D as l}from"./DattaNetworkDataTable-CKoFfAgq.js";import{D as c}from"./DattaPageTitle-T82UHXFU.js";import{D as d}from"./DattaModal-BlJ6BfOc.js";import{D as o}from"./DattaForm-CDg-NNVW.js";import{D as u}from"./DattaCheckbox-DNdiamZ9.js";import"./vendor-react-DjGYZWH8.js";import"./dynamic-D4zAvdYy.js";import"./DattaTabs-D7AxHKPN.js";function m({individuId:a,onClose:r}){const[l,c]=s.useState(null),[d,o]=s.useState([]),[u,m]=s.useState([]),[h,x]=s.useState(null),g=s.useCallback((async()=>{const[e,s,i]=await Promise.all([window.api.getIndividu(a),window.api.getCategories(),window.api.getUsers()]);e.success&&c(e.data),s.success&&o((s.data||[]).filter((e=>1!==e.deleted)).sort(((e,s)=>(e.ordre||0)-(s.ordre||0)))),i.success&&m(i.data)}),[a]);s.useEffect((()=>{g()}),[g]),s.useEffect((()=>{if(d.length>0&&null===h){const e=d.find((e=>(e.champs||[]).some((e=>e.visible))));e&&x(e.id)}}),[d,h]);const p=(s,i,n="text",a=!1)=>{let r;if("boolean"===n)r=i?e.jsxs("span",{className:"badge bg-success",children:[e.jsx("i",{className:"feather icon-check me-1"}),"Oui"]}):e.jsxs("span",{className:"badge bg-danger",children:[e.jsx("i",{className:"feather icon-x me-1"}),"Non"]});else if("date"===n){const s=t(i);r=s?e.jsxs("span",{className:"text-info",children:[e.jsx("i",{className:"feather icon-calendar me-1"}),s]}):e.jsx("span",{className:"fst-italic text-muted",children:"Non renseigné"})}else r=null!=i&&""!==i?String(i):e.jsx("span",{className:"fst-italic text-muted",children:"Non renseigné"});return e.jsx("div",{className:`col-md-${a?"12":"6"} mb-3`,children:e.jsxs("div",{className:"d-flex align-items-center p-3 border rounded",children:[e.jsx("div",{className:"avtar avtar-s bg-light-primary me-3",children:e.jsx("i",{className:"feather icon-hash"})}),e.jsxs("div",{children:[e.jsx("h6",{className:"mb-0",children:s}),e.jsx("p",{className:"mb-0",children:r})]})]})})};if(!l)return e.jsx("div",{className:"d-flex justify-content-center p-4",children:e.jsx("span",{children:"Chargement..."})});const f=l.champs_supplementaires||{};return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"modal-content",children:[e.jsx("div",{className:"modal-header",children:e.jsxs("h2",{className:"mb-0",children:["Fiche Individu : ",l.numero_unique||l.id]})}),e.jsx("div",{className:"modal-body",children:e.jsxs(i,{className:"mb-0",actions:e.jsx(n,{variant:"light-secondary",onClick:r,icon:"ti ti-arrow-left",children:"Retour"}),children:[e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-12 mt-4 mb-2",children:e.jsx("h5",{className:"border-bottom pb-2 mb-0",children:"Informations principales"})}),p("Numéro Unique",l.numero_unique||l.id),p("Personne en charge",(e=>{const s=u.find((s=>s.id===Number(e)));return s?s.username:"Non assigné"})(l.en_charge))]}),d.some((e=>(e.champs||[]).some((e=>e.visible))))&&e.jsxs(e.Fragment,{children:[e.jsx("ul",{className:"nav nav-tabs mt-4",children:d.map((s=>0===(s.champs||[]).filter((e=>e.visible)).length?null:e.jsx("li",{className:"nav-item",children:e.jsxs("button",{type:"button",className:"nav-link "+(h===s.id?"active":""),onClick:()=>x(s.id),children:[e.jsx("i",{className:"feather icon-folder me-2"}),s.nom]})},`tab-${s.id}`)))}),e.jsx("div",{className:"tab-content pt-3",children:d.map((s=>{const i=(s.champs||[]).filter((e=>e.visible));return 0===i.length?null:e.jsx("div",{className:"tab-pane fade "+(h===s.id?"show active":""),children:e.jsx("div",{className:"row",children:i.map((e=>p((e=>{for(const s of d){const i=(s.champs||[]).find((s=>s.key===e));if(i)return i.label}return e})(e.key),f[e.key],e.type,!1)))})},`content-${s.id}`)}))})]})]})})]})})}const h=()=>"undefined"!=typeof window&&window.location&&window.location.hash&&window.location.hash.includes("/mine")?"mine":"all",x=(e,s)=>{var i;if("actions"===e)return"80px";if("numero_unique"===e)return"120px";if("en_charge"===e)return"150px";const n=s.find((s=>s.key===e));if(!n)return"130px";switch(n.type){case"date":return"110px";case"boolean":return"80px";case"number":return"100px";case"list":return"140px";default:const e=(null==(i=n.label)?void 0:i.length)||12,s=Math.max(120,8*e+40);return`${Math.min(s,250)}px`}};function g({user:g,requestedView:p,onRequestedViewConsumed:f}){const[j,v]=s.useState(h),[N,b]=s.useState([]),[w,y]=s.useState([]),[k,C]=s.useState(!0),[S,_]=s.useState(null),[D,q]=s.useState(""),[I,E]=s.useState([]),[M,L]=s.useState(!1),[z,P]=s.useState([]),[A,T]=s.useState(null),[$,F]=s.useState(!1),[R,O]=s.useState(1),[U,V]=s.useState(null),[G,J]=s.useState(0),{performSync:B}=a(),H=s.useMemo((()=>Number(g.id||g.userId)),[g.id,g.userId]),K=s.useMemo((()=>{const e={actions:x("actions",z),numero_unique:x("numero_unique",z),en_charge:x("en_charge",z)};return I.forEach((s=>{z.find((e=>e.key===s))&&!e[s]&&(e[s]=x(s,z))})),e}),[z,I]),Q=s.useCallback(((e,s=null)=>{if(null==e||""===e)return"Non assigné";const i=Number(e),n=w.find((e=>e.id===i));return n?n.username:s&&s.en_charge_username?s.en_charge_username:`Utilisateur #${e}`}),[w]),W=s.useCallback(((s,i=null)=>null==s||""===s?e.jsx("span",{className:"text-muted fst-italic",children:"Non assigné"}):Q(s,i)),[Q]),X=s.useMemo((()=>{const s=[{key:"actions",header:"Actions",sortable:!1,filterable:!1,thStyle:{textAlign:"center",width:K.actions},tdStyle:{textAlign:"center",width:K.actions},render:s=>e.jsxs(e.Fragment,{children:[e.jsx(n,{variant:"light-primary",size:"sm",className:"me-1",onClick:()=>T(s.id),title:"Modifier",icon:"feather icon-edit"}),e.jsx(n,{variant:"light-danger",size:"sm",onClick:()=>ae(s.id),title:"Supprimer",icon:"feather icon-trash-2"})]})},{key:"numero_unique",header:"N° Individu",sortable:!0,filterable:!0,render:e=>e.numero_unique||e.id},{key:"en_charge",header:"En charge",sortable:!0,filterable:!0,render:s=>s.en_charge?e.jsxs("span",{className:"badge bg-success",children:[e.jsx("i",{className:"feather icon-user me-1"}),Q(s.en_charge,s)]}):e.jsxs("span",{className:"badge bg-warning",children:[e.jsx("i",{className:"feather icon-user-x me-1"}),"Non assigné"]})}];return I.forEach((e=>{const i=z.find((s=>s.key===e));i&&s.push({key:e,header:i.label,sortable:!0,filterable:!0,render:s=>{const n=(s.champs_supplementaires||{})[e];return"boolean"===i.type?n?"Oui":"Non":"date"===i.type||n instanceof Date||"string"==typeof n&&!isNaN(Date.parse(n))?t(n):null==n?"":String(n)}})})),s}),[I,z,W]),Y=s.useMemo((()=>{if(k||0===N.length)return[];let e=[...N];if("mine"===j&&(e=e.filter((e=>String(e.en_charge)===String(H)))),D&&""!==D.trim()){const s=D.toLowerCase().trim();e=e.filter((e=>{if(String(e.numero_unique||"").toLowerCase().includes(s))return!0;if(Q(e.en_charge,e).toLowerCase().includes(s))return!0;const i=e.champs_supplementaires||{};return Object.values(i).some((e=>String(e||"").toLowerCase().includes(s)))}))}return U&&e.sort(((e,s)=>{let i,n;return"numero_unique"===U.key?(i=e.numero_unique,n=s.numero_unique):"en_charge"===U.key?(i=Q(e.en_charge,e),n=Q(s.en_charge,s)):(i=(e.champs_supplementaires||{})[U.key],n=(s.champs_supplementaires||{})[U.key]),i=null==i?"":String(i).toLowerCase(),n=null==n?"":String(n).toLowerCase(),i<n?"ascending"===U.direction?-1:1:i>n?"ascending"===U.direction?1:-1:0})),e}),[N,j,H,D,U,k,Q]);s.useEffect((()=>{const e=()=>{const e=h();j!==e&&(v(e),J((e=>e+1)))};return window.addEventListener("hashchange",e),()=>window.removeEventListener("hashchange",e)}),[j]),s.useEffect((()=>{if(p){if(j!==p&&(v(p),J((e=>e+1))),"undefined"!=typeof window&&window.location){const e="mine"===p?"#individus/mine":"#individus/all";window.location.hash!==e&&(window.location.hash=e)}f&&setTimeout((()=>{f()}),100)}}),[p,f,j]);const Z=s.useCallback((async()=>{try{const[e,s]=await Promise.all([window.api.getIndividus(),window.api.getUsers()]);if(!e.success)throw new Error(e.error||"Erreur lors du chargement des individus");if(b(e.data||[]),!s.success)throw new Error(s.error||"Erreur lors du chargement des utilisateurs");y(s.data||[]),await B()}catch(e){throw e}}),[B]),ee=s.useCallback((e=>{if(j!==e&&(v(e),J((e=>e+1))),"undefined"!=typeof window&&window.location){const s="mine"===e?"#individus/mine":"#individus/all";window.location.hash!==s&&(window.location.hash=s)}}),[j]),se=s.useCallback((()=>F(!0)),[]),ie=s.useCallback((()=>{Z(),F(!1)}),[Z]);s.useCallback((()=>{Z(),T(null)}),[Z]);const ne=s.useCallback((()=>L((e=>!e))),[]),ae=s.useCallback((async e=>{if(window.confirm("Supprimer cet individu ?"))try{const s=await window.api.deleteIndividu({id:e,userId:H});s.success?Z():alert(s.error||"Erreur lors de la suppression")}catch(s){alert(s.message)}}),[H,Z]),te=s.useCallback((e=>{const s=I.includes(e)?I.filter((s=>s!==e)):[...I,e];E(s),localStorage.setItem("individusListColumnConfig",JSON.stringify(s))}),[I]),re=s.useCallback((e=>{let s="ascending";if(U&&U.key===e){if("ascending"!==U.direction)return void V(null);s="descending"}V({key:e,direction:s})}),[U]);return k&&0===N.length?e.jsxs("div",{className:"pc-content",children:[e.jsx(c,{title:"Gestion des individus"}),e.jsx("div",{className:"card",children:e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"loading-message",children:"Chargement des données initiales..."})})})]}):S?e.jsxs("div",{className:"pc-content",children:[e.jsx(c,{title:"Gestion des individus"}),e.jsx("div",{className:"card",children:e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"error-message",children:[S,e.jsx(n,{variant:"secondary",onClick:Z,className:"mt-2",children:"Réessayer de charger"})]})})})]}):e.jsxs("div",{className:"pc-content",children:[e.jsx(c,{title:"Gestion des individus"}),e.jsxs(i,{title:"Liste des individus",actions:e.jsx(n,{variant:"primary",size:"sm",icon:"feather icon-plus",onClick:se,children:"Ajouter un individu"}),children:[e.jsx("div",{className:"row mb-4",children:e.jsx("div",{className:"col-md-3",children:e.jsxs("div",{className:"d-flex align-items-center p-3 bg-light-primary rounded",children:[e.jsx("div",{className:"avtar avtar-s bg-primary me-3",children:e.jsx("i",{className:"feather icon-database"})}),e.jsxs("div",{children:[e.jsx("h6",{className:"mb-0",children:"Total"}),e.jsx("p",{className:"mb-0 text-primary fw-bold",children:N.length})]})]})})}),e.jsxs("div",{className:"mb-3 text-muted small",children:[e.jsx("strong",{children:"Mode d'affichage:"})," ","mine"===j?"Mes individus":"Tous les individus"," |",e.jsx("strong",{className:"ms-1",children:"Individus affichés:"})," ",Y.length]}),e.jsxs("div",{className:"row g-2 align-items-end mb-3",children:[e.jsxs("div",{className:"col-auto",children:[e.jsx(n,{variant:"all"===j?"primary":"secondary",size:"sm",onClick:()=>ee("all"),className:"me-1",children:"Tous les individus"}),e.jsx(n,{variant:"mine"===j?"primary":"secondary",size:"sm",onClick:()=>ee("mine"),children:"Mes individus"})]}),e.jsx("div",{className:"col-md-4 ms-auto",children:e.jsx(o,{placeholder:"Rechercher...",value:D,onChange:e=>q(e.target.value)})}),e.jsx("div",{className:"col-auto",children:e.jsx(n,{variant:"secondary",size:"sm",onClick:ne,children:M?"Masquer le sélecteur":"Configurer les colonnes"})})]}),M&&e.jsxs("div",{className:"colonnes-picker",children:[e.jsx("h4",{children:"Choisir les colonnes de champs supplémentaires à afficher:"}),e.jsxs("div",{className:"colonnes-grid",children:[z.map((s=>e.jsx("div",{className:"colonne-option",children:e.jsx(u,{id:`col-${s.key}`,label:e.jsxs("span",{children:[s.label," ",e.jsxs("small",{className:"text-muted",children:["(",s.categorieNom,")"]})]}),checked:I.includes(s.key),onChange:()=>te(s.key)})},s.key))),0===z.length&&e.jsx("p",{className:"text-muted fst-italic",children:"Aucun champ supplémentaire configurable n'est défini."})]})]}),k&&e.jsx("div",{className:"loading-message mt-2",children:"Mise à jour des données..."}),!k&&0===Y.length&&e.jsxs("div",{className:"no-data-message mt-4 text-center",children:[e.jsx("p",{children:D||"mine"===j?"Aucun individu ne correspond à vos critères.":"Aucun individu enregistré."}),"mine"===j&&N.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("p",{className:"text-muted mb-2",children:["Vous n'avez aucun individu assigné. ",N.length," au total."]}),e.jsx(n,{variant:"secondary",size:"sm",onClick:()=>ee("all"),children:"Voir tous"})]})]}),!k&&Y.length>0&&e.jsx(l,{data:Y,columns:X,loading:k,error:S,onLoadData:Z,refreshInterval:3e4,maxRetries:3,pagination:{currentPage:R,itemsPerPage:20,totalItems:Y.length,onPageChange:O},sorting:{sortConfig:U,onSort:re}}),$&&e.jsx(d,{open:!0,onClose:()=>F(!1),title:"Nouvel individu",size:"lg",scrollable:!0,children:e.jsx(r,{user:g,onClose:()=>F(!1),onSuccess:ie})}),A&&e.jsx(d,{open:!0,onClose:()=>T(null),title:"Fiche individu",size:"xl",scrollable:!0,children:e.jsx(m,{individuId:A,onClose:()=>T(null)})})]})]},`list-container-${G}`)}export{g as default};
