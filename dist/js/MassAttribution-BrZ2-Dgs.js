import{j as e}from"./vendor-ui-CtvHukzg.js";import{r as s}from"./vendor-data-BY55b65u.js";import{D as a}from"./DattaPageTitle-T82UHXFU.js";import{D as t}from"./DattaCard-Ca8oAgyz.js";import{u as i,a as r,D as l}from"./main-BtLJocfP.js";import{D as n}from"./DattaCheckbox-DNdiamZ9.js";import{a as c,D as o}from"./DattaForm-CDg-NNVW.js";import{D as d}from"./DattaNetworkDataTable-CKoFfAgq.js";import"./vendor-react-DjGYZWH8.js";function u({user:u}){const[m,h]=s.useState(!1),[p,v]=s.useState(""),[x,j]=s.useState(1),[g,b]=s.useState([]),[f,N]=s.useState([]),[y,w]=s.useState([]),[C,S]=s.useState([]),[k,E]=s.useState([]),[A,I]=s.useState([]),[T,z]=s.useState("all"),[D,F]=s.useState([]),[q,L]=s.useState(!1),[_,U]=s.useState([]),[$,W]=s.useState(""),[O,V]=s.useState(""),[R,P]=s.useState({total:0,nonAssignes:0,assignes:0,parUtilisateur:{},selected:0}),{performSync:M}=i();s.useCallback((async()=>{h(!0),v("");try{const e=await window.api.getUsers();if(!e||!e.success)throw new Error("Erreur lors du chargement des utilisateurs");{const s=[...e.data].sort(((e,s)=>e.username.localeCompare(s.username)));b(s)}const s=await window.api.getCategories();if(!s||!s.success)throw new Error("Erreur lors du chargement des catégories");{const e=[...s.data].sort(((e,s)=>(e.ordre||0)-(s.ordre||0)));N(e);const a=[];e.forEach((e=>{e.champs&&Array.isArray(e.champs)&&[...e.champs].sort(((e,s)=>(e.ordre||0)-(s.ordre||0))).forEach((s=>{s.visible&&a.push({...s,categorieNom:e.nom,categorieId:e.id})}))})),w(a)}await B(),await M()}catch(e){v(`Erreur d'initialisation: ${e.message}`)}finally{h(!1)}}),[M]);const B=async()=>{h(!0),v("");try{const e=u.id||u.userId,s=u.role,a=await window.api.getIndividus(e,s);if(!a||!a.success)throw new Error("Erreur lors du chargement des individus");{const e=Array.isArray(a.data)?a.data:[];S(e);const s=e.filter((e=>!e.en_charge)).length,t=e.length-s,i={};e.forEach((e=>{e.en_charge&&(i[e.en_charge]=(i[e.en_charge]||0)+1)})),P({total:e.length,nonAssignes:s,assignes:t,parUtilisateur:i,selected:0}),G(e)}}catch(e){v(`Erreur: ${e.message}`),E([])}finally{h(!1)}},G=e=>{if(!Array.isArray(e)||0===e.length)return void E([]);let s=[...e];A.length>0&&(s=s.filter((e=>"all"===T?A.every((s=>H(e,s))):A.some((s=>H(e,s)))))),E(s),P((e=>({...e,selected:0}))),F([]),L(!1)},H=(e,s)=>{var a;const t=null==(a=e.champs_supplementaires)?void 0:a[s.field.key];switch(s.operator){case"equals":return String(t)===String(s.value);case"notEquals":return String(t)!==String(s.value);case"contains":return String(t||"").toLowerCase().includes(String(s.value).toLowerCase());case"startsWith":return String(t||"").toLowerCase().startsWith(String(s.value).toLowerCase());case"endsWith":return String(t||"").toLowerCase().endsWith(String(s.value).toLowerCase());case"greaterThan":return Number(t)>Number(s.value);case"lessThan":return Number(t)<Number(s.value);case"empty":return!t||""===t;case"notEmpty":return!!t&&""!==t;default:return!0}},J=()=>{var a;const[t,i]=s.useState(""),[r,n]=s.useState("equals"),[c,o]=s.useState(""),d=y.find((e=>e.key===t)),u=(()=>{if(!d)return[];const e=[{value:"equals",label:"Est égal à"},{value:"notEquals",label:"N'est pas égal à"},{value:"empty",label:"Est vide"},{value:"notEmpty",label:"N'est pas vide"}];switch(d.type){case"text":return[...e,{value:"contains",label:"Contient"},{value:"startsWith",label:"Commence par"},{value:"endsWith",label:"Se termine par"}];case"number":return[...e,{value:"greaterThan",label:"Supérieur à"},{value:"lessThan",label:"Inférieur à"}];case"date":return[...e,{value:"greaterThan",label:"Après le"},{value:"lessThan",label:"Avant le"}];case"checkbox":return[{value:"equals",label:"Est coché"},{value:"notEquals",label:"N'est pas coché"}];default:return e}})(),m=()=>!["empty","notEmpty"].includes(r);return e.jsxs("div",{className:"field-filter-creator",children:[e.jsx("h4",{children:"Ajouter un filtre de champ"}),e.jsxs("div",{className:"filter-form",children:[e.jsxs("div",{className:"filter-field-select",children:[e.jsx("label",{children:"Champ:"}),e.jsxs("select",{value:t,onChange:e=>{i(e.target.value),n("equals"),o("")},className:"form-select",children:[e.jsx("option",{value:"",children:"Sélectionner un champ"}),f.map((s=>{var a;return e.jsx("optgroup",{label:s.nom,children:null==(a=s.champs)?void 0:a.filter((e=>e.visible)).sort(((e,s)=>(e.ordre||0)-(s.ordre||0))).map((s=>e.jsx("option",{value:s.key,children:s.label},s.key)))},s.id)}))]})]}),t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"filter-operator-select",children:[e.jsx("label",{children:"Opérateur:"}),e.jsx("select",{value:r,onChange:e=>{n(e.target.value),m()||o("")},className:"form-select",children:u.map((s=>e.jsx("option",{value:s.value,children:s.label},s.value)))})]}),m()&&e.jsxs("div",{className:"filter-value-input",children:[e.jsx("label",{children:"Valeur:"}),"checkbox"===(null==d?void 0:d.type)?e.jsxs("select",{value:String(c),onChange:e=>o(e.target.value),className:"form-select",children:[e.jsx("option",{value:"true",children:"Oui (coché)"})," ",e.jsx("option",{value:"false",children:"Non (décoché)"})]}):"list"===(null==d?void 0:d.type)&&(null==(a=d.options)?void 0:a.length)>0?e.jsxs("select",{value:c,onChange:e=>o(e.target.value),className:"form-select",children:[e.jsx("option",{value:"",children:"Sélectionner..."}),d.options.map(((s,a)=>e.jsx("option",{value:s,children:s},a)))]}):e.jsx("input",{type:"number"===(null==d?void 0:d.type)?"number":"date"===(null==d?void 0:d.type)?"date":"text",className:"form-control",value:c,onChange:e=>o(e.target.value),placeholder:`Saisissez la valeur pour ${(null==d?void 0:d.label)||"ce champ"}`})]})]}),e.jsx(l,{type:"button",variant:"primary",size:"sm",onClick:()=>{if(!t||!d)return;if(m()&&!c&&"checkbox"!==d.type)return void v("Veuillez entrer une valeur pour le filtre.");let e=c;var s;"checkbox"===d.type&&(e="true"===c),s={field:d,operator:r,value:e},I((e=>[...e,s])),G(C),i(""),n("equals"),o(""),v("")},disabled:!t||m()&&""===c&&"checkbox"!==(null==d?void 0:d.type),children:"Ajouter ce filtre"})]})]})},K=()=>_.reduce(((e,s)=>e+(parseFloat(s.percentage)||0)),0),Q=e=>{if(!e)return"Non assigné";const s=g.find((s=>s.id===Number(e)));return s?s.username:`Utilisateur #${e}`},X=()=>{I([]),G(C)};return e.jsxs("div",{className:"pc-content",children:[e.jsx(a,{title:"Attribution de masse"}),e.jsxs(t,{title:"Attribution de masse",className:"mass-attribution-wizard",children:[p&&e.jsx(r,{type:p.includes("réussie")||p.includes("succès")?"success":"danger",children:p}),e.jsxs("ul",{className:"nav nav-pills nav-justified wizard-steps mb-4",children:[e.jsx("li",{className:"nav-item",children:e.jsxs("span",{className:"nav-link "+(1===x?"active":""),children:[e.jsx("i",{className:"feather icon-filter me-2"}),"Sélection"]})}),e.jsx("li",{className:"nav-item",children:e.jsxs("span",{className:"nav-link "+(2===x?"active":""),children:[e.jsx("i",{className:"feather icon-users me-2"}),"Attribution"]})}),e.jsx("li",{className:"nav-item",children:e.jsxs("span",{className:"nav-link "+(3===x?"active":""),children:[e.jsx("i",{className:"feather icon-check-circle me-2"}),"Confirmation"]})})]}),e.jsxs("div",{className:"wizard-content",children:[1===x&&e.jsxs("div",{className:"wizard-panel row",children:[e.jsx("div",{className:"col-md-4",children:e.jsxs(t,{title:"Filtres de sélection",children:[e.jsxs("div",{className:"filters-header d-flex justify-content-between",children:[e.jsx("h3",{className:"mb-0",children:"Filtres"}),e.jsx(l,{variant:"secondary",size:"sm",onClick:X,children:"Réinitialiser"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label mb-2",children:"Opérateur de combinaison des filtres de champs:"}),e.jsxs("ul",{className:"nav nav-pills",children:[e.jsx("li",{className:"nav-item",children:e.jsx("button",{className:"nav-link "+("all"===T?"active":""),onClick:()=>{z("all"),G(C)},children:"ET"})}),e.jsx("li",{className:"nav-item",children:e.jsx("button",{className:"nav-link "+("any"===T?"active":""),onClick:()=>{z("any"),G(C)},children:"OU"})})]})]}),e.jsx(J,{}),A.length>0&&e.jsxs("div",{className:"active-field-filters",children:[e.jsx("h4",{children:"Filtres de champs actifs"}),e.jsx("ul",{children:A.map(((s,a)=>e.jsxs("li",{className:"field-filter-item",children:[e.jsxs("span",{className:"field-filter-info",children:[e.jsx("strong",{children:s.field.label})," ","equals"===s.operator?"est égal à":"notEquals"===s.operator?"n'est pas égal à":"contains"===s.operator?"contient":"startsWith"===s.operator?"commence par":"endsWith"===s.operator?"se termine par":"greaterThan"===s.operator?"est supérieur à":"lessThan"===s.operator?"est inférieur à":"empty"===s.operator?"est vide":"notEmpty"===s.operator?"n'est pas vide":s.operator," ",!["empty","notEmpty"].includes(s.operator)&&e.jsxs("span",{className:"filter-value",children:['"',!0===s.value?"Oui":!1===s.value?"Non":s.value,'"']})]}),e.jsx("button",{onClick:()=>(e=>{I((s=>s.filter(((s,a)=>a!==e)))),G(C)})(a),className:"btn-remove-filter",title:"Supprimer",children:"×"})]},a)))})]})]})}),e.jsx("div",{className:"col-md-8",children:e.jsxs(t,{title:"Individus disponibles",children:[e.jsxs("div",{className:"stats-panel",children:[e.jsxs("div",{className:"stats-item",children:[e.jsx("span",{className:"stats-label",children:"Total:"}),e.jsx("span",{className:"stats-value",children:R.total})]}),e.jsxs("div",{className:"stats-item",children:[e.jsx("span",{className:"stats-label",children:"Non assignés:"}),e.jsx("span",{className:"stats-value",children:R.nonAssignes})]}),e.jsxs("div",{className:"stats-item",children:[e.jsx("span",{className:"stats-label",children:"Assignés:"}),e.jsx("span",{className:"stats-value",children:R.assignes})]}),e.jsxs("div",{className:"stats-item highlight",children:[e.jsx("span",{className:"stats-label",children:"Filtrés:"}),e.jsx("span",{className:"stats-value",children:k.length})]}),e.jsxs("div",{className:"stats-item highlight primary",children:[e.jsx("span",{className:"stats-label",children:"Sélectionnés:"}),e.jsx("span",{className:"stats-value",children:D.length})]})]}),e.jsxs("div",{className:"individus-selection",children:[e.jsx("div",{className:"table-header",children:e.jsx(n,{id:"selectAll",label:`Tout sélectionner (${k.length})`,className:"select-all",checked:q,onChange:()=>{if(q)F([]),P((e=>({...e,selected:0})));else{const e=k.map((e=>e.id));F(e),P((s=>({...s,selected:e.length})))}L(!q)},disabled:0===k.length})}),m?e.jsx("div",{className:"loading",children:"Chargement des individus..."}):0===k.length?e.jsxs("div",{className:"no-results",children:[e.jsx("p",{children:"Aucun individu ne correspond."}),e.jsx(l,{variant:"secondary",size:"sm",onClick:X,children:"Réinitialiser les filtres"})]}):e.jsx(d,{data:k,columns:[{title:"",dataIndex:"selection",key:"selection",width:"40px",render:(s,a)=>e.jsx(n,{id:`sel-${a.id}`,checked:D.includes(a.id),onChange:()=>(e=>{let s;s=D.includes(e)?D.filter((s=>s!==e)):[...D,e],F(s),P((e=>({...e,selected:s.length}))),L(s.length===k.length&&k.length>0)})(a.id)})},{title:"N° Individu",dataIndex:"numero_unique",key:"numero_unique",render:(e,s)=>s.numero_unique||s.id},{title:"En charge",dataIndex:"en_charge",key:"en_charge",render:(s,a)=>e.jsx("span",{className:a.en_charge?"":"unassigned",children:Q(a.en_charge)})},...A.map((e=>({title:e.field.label,dataIndex:e.field.key,key:e.field.key,render:(s,a)=>{var t;const i=null==(t=a.champs_supplementaires)?void 0:t[e.field.key];return"boolean"==typeof i?i?"Oui":"Non":i||""}})))],loading:m,error:p,onLoadData:B,refreshInterval:3e4,maxRetries:3,rowClassName:e=>D.includes(e.id)?"selected-row":""})]}),e.jsx("div",{className:"wizard-actions",children:e.jsxs(l,{variant:"primary",onClick:()=>{0!==D.length?(U([]),W(""),V(""),j(2)):v("Veuillez sélectionner au moins un individu.")},disabled:0===D.length,children:["Continuer (",D.length," sélectionnés)"]})})]})})]}),2===x&&e.jsx("div",{className:"wizard-panel",style:{flexDirection:"column"},children:e.jsxs(t,{title:`Définir la distribution pour ${D.length} individu(s)`,children:[e.jsxs("div",{className:"attribution-form-distribution",children:[e.jsxs("div",{className:"mb-3 add-user-to-distribution-form",children:[e.jsx(c,{id:"userToAddToDistribution",label:"Utilisateur à ajouter",value:$,onChange:e=>W(e.target.value),options:[{value:"",label:"-- Sélectionner un utilisateur --"},...g.filter((e=>!_.find((s=>s.userId===String(e.id))))).map((e=>({value:String(e.id),label:e.username})))]}),e.jsx(o,{id:"percentageForUser",label:"Pourcentage d'activité/capacité",type:"number",value:O,onChange:e=>V(e.target.value),placeholder:"Exemple : 50",min:"0",max:"100"}),e.jsx(l,{variant:"secondary",type:"button",onClick:()=>{if(!$||!O)return void v("Veuillez sélectionner un utilisateur et entrer un pourcentage.");const e=parseFloat(O);if(isNaN(e)||e<=0||e>100)return void v("Le pourcentage doit être un nombre entre 1 et 100.");if(_.find((e=>e.userId===$)))return void v("Cet utilisateur est déjà dans la liste de distribution.");const s=g.find((e=>e.id===Number($)));U([..._,{userId:$,username:(null==s?void 0:s.username)||`Utilisateur ${$}`,percentage:e}]),W(""),V(""),v("")},children:"Ajouter à la distribution"})]}),_.length>0&&e.jsxs("div",{className:"distribution-list-section",children:[e.jsx("h4",{children:"Utilisateurs pour cette attribution :"}),e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"simple-table table table-hover table-sm",style:{width:"100%",marginTop:"10px"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Utilisateur"}),e.jsx("th",{children:"Pourcentage (%)"}),e.jsx("th",{children:"Action"})]})}),e.jsx("tbody",{children:_.map((s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.username}),e.jsx("td",{children:e.jsx("input",{type:"number",value:s.percentage,onChange:e=>((e,s)=>{const a=parseFloat(s);isNaN(a)&&""!==s?v("Le pourcentage doit être un nombre."):""!==s&&(a<0||a>100)?v("Le pourcentage doit être entre 0 et 100."):(v(""),U(_.map((t=>t.userId===e?{...t,percentage:""===s?"":a}:t))))})(s.userId,e.target.value),min:"0",max:"100",style:{width:"80px"}})}),e.jsx("td",{children:e.jsx(l,{variant:"danger",size:"sm",onClick:()=>{return e=s.userId,void U(_.filter((s=>s.userId!==e)));var e},children:"Retirer"})})]},s.userId)))})]})}),e.jsxs("p",{style:{marginTop:"10px",fontWeight:"bold"},children:["Total pourcentage alloué : ",K(),"%"]}),K()>100&&e.jsx("p",{className:"error-message",children:"Attention: Le total des pourcentages dépasse 100%!"}),K()<100&&K()>0&&_.length>0&&e.jsx("p",{className:"warning-message",children:"Note: Le total des pourcentages est inférieur à 100%. Certains cas pourraient ne pas être distribués si le nombre d'individus est supérieur à la capacité totale définie."})]})]}),e.jsxs("div",{className:"wizard-actions",children:[e.jsx(l,{variant:"secondary",onClick:()=>j(1),children:"Retour à la sélection"}),e.jsx(l,{variant:"primary",onClick:async()=>{if(0===D.length)return void v("Veuillez sélectionner au moins un individu.");if(0===_.length)return void v("Veuillez ajouter au moins un utilisateur à la liste de distribution avec un pourcentage.");const e=K();if(0===e&&_.some((e=>parseFloat(e.percentage)>0)))v("Au moins un utilisateur doit avoir un pourcentage supérieur à 0 si des utilisateurs sont dans la liste.");else if(e>100)v(`Le total des pourcentages (${e}%) ne peut pas dépasser 100%.`);else if(_.some((e=>""===e.percentage||isNaN(parseFloat(e.percentage))||parseFloat(e.percentage)<0)))v("Tous les utilisateurs dans la distribution doivent avoir un pourcentage valide (0-100).");else{h(!0),v("");try{const e={individuIds:D,managerUserId:u.id||u.userId,distribution:_.map((e=>({userId:Number(e.userId),percentage:parseFloat(e.percentage)})))},s=await window.api.attribuerIndividusEnMasse(e);if(!s||!s.success)throw new Error((null==s?void 0:s.error)||"Erreur lors de l'attribution");v(`Attribution réussie ! ${s.updatedCount||D.length} affectations mises à jour.`),j(3)}catch(s){v(`Erreur: ${s.message}`)}finally{h(!1)}}},disabled:m||0===_.length||_.some((e=>""===e.percentage||0===parseFloat(e.percentage)))&&0===K(),children:m?"Attribution en cours...":"Attribuer les individus"})]})]})}),3===x&&e.jsx("div",{className:"wizard-panel",children:e.jsxs("div",{className:"confirmation",children:[e.jsx("h3",{children:"Attribution terminée"}),e.jsx(r,{type:"success",className:"mb-3",children:p}),e.jsx("div",{className:"confirmation-actions",children:e.jsx(l,{variant:"primary",onClick:()=>{j(1),F([]),L(!1),U([]),W(""),V(""),B()},children:"Nouvelle attribution de masse"})})]})})]})]})]})}export{u as default};
